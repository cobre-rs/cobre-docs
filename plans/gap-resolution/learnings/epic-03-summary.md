# Learnings from Epic 03: LP Layout and State Vectors

## What Went Well

- **All tickets passed guardian on first attempt**: tickets 008, 009, and 010 each passed guardian verification with zero failures. The rigorous arithmetic pre-verification done in ticket-008 (column/row index formulas) prevented propagated errors in ticket-009 (StageIndexer) and the worked example in ticket-010's patch sequence table.
- **Symmetric index design validated cleanly**: The intentional symmetry between column index $h$ (storage) / $N + \ell \cdot N + h$ (lag) and row index $h$ (water balance) / $N + \ell \cdot N + h$ (lag fixing) was not just a design goal — it became an explicit verification criterion in the worked example. The guardian confirmed column 3 = row 3, column 8 = row 8, etc. for the 3-hydro AR(2) example, providing high confidence in the index arithmetic.
- **Cross-file consistency maintained end-to-end**: `solver-abstraction.md` SS2.1/SS2.2 defines the index formulas; `training-loop.md` SS4.2a and SS5 reference them by section rather than duplicating them; `solver-interface-trait.md` SS4.4 adds construction ownership without duplicating layout details; `lp-formulation.md` adds a single reverse cross-reference. The "one canonical source, multiple cross-references" pattern held throughout.
- **Performance notes are concrete and actionable**: The SIMD alignment requirement (64 bytes = AVX-512 width for 8 f64 values) and the cache locality analysis ($n_{state} = 2{,}080$ at $N=160$, $L=12$) are numeric, reproducible, and directly usable by an implementer. No vague "consider SIMD" guidance.
- **Worked example from ticket-008 reused in ticket-009 and ticket-010**: The 3-hydro AR(2) system ($N=3$, $L=2$, H1 FPHA with 4 planes) defined in SS2.4 was reused verbatim in the StageIndexer worked example (SS5.5.3) and the forward pass patch sequence table (SS4.2a). This consistency across three sections of two different files prevents divergence as specs evolve.

## What Could Be Improved

- **ticket-010 scope deduction (lp-formulation.md)**: The guardian applied a `scope_adherence: 0.5` deduction (quality 0.875 vs expected 1.0) because the specialist edited `lp-formulation.md` to add a cross-reference, which was not listed in the ticket's Key Files. The cross-reference addition was correct and valuable, but the ticket specification should have either listed `lp-formulation.md` as a "Possibly edit" file or included it in the scope explicitly. Future bookkeeping tickets should audit all files that reference the changed specs and list them as candidates.
- **ticket-010 boundary score low (0.20)**: The readiness scoring flagged unclear scope boundary — the ticket says "Possibly edit" for cross-reference files, which is ambiguous. A clear list of files to check (with explicit pass/fail criteria) would have raised the boundary score and reduced the guardian's scope ambiguity.
- **Uncommitted-working-tree pattern persists**: As with epic-02, the epic-03 files are in the working tree but not committed until the epic boundary commit. This means `git diff 1911965..HEAD` returns empty output — all changes are working-tree modifications. The learnings extraction must rely on reading the files directly rather than using git diff ranges. This is an expected pattern for this plan but should be noted for any future tooling that assumes committed state.
- **AR dynamics row in worked example uses a placeholder**: The patch sequence table (Training Loop SS4.2a) shows `ar_dynamics_row(h)` as `(*)` with a footnote "depends on bus and block counts" for the noise fixing patches. This is correct but leaves a loose end — a developer implementing the forward pass will need to compute this offset explicitly. Consider a follow-up ticket to fill in the exact middle-region offset formula once the full constraint ordering is settled.

## Technical Decisions

- **Uniform lag storage (all hydros store L lags)**: Hydros with AR order $P_h < L$ store zero-padded lags beyond their actual order. This decision was specified by the stakeholder and is now documented explicitly in SS2.1 with rationale (uniform stride enables SIMD, no per-hydro offset tables, simplified index arithmetic). The padding is zero AR coefficients, not zero values — this distinction matters for cut coefficient computation.
- **State transfer drops oldest lag**: The state transfer slice is `primal[0 .. N*(1 + L-1)]`, dropping the oldest lag (position $L-1$). This is documented in SS2.1 with the formula $n_{transfer} = N \cdot L$ and the note that the new stage shifts lags by one position and writes the newly computed inflow into lag position 0. This design choice avoids storing a lag that is never used in the next stage's AR dynamics.
- **StageIndexer owned by stage definition, not solver**: The indexer is associated with the `StageTemplate` (`solver-interface-trait.md` SS4.4), not with any solver instance. This means it is constructed once at initialization, shared read-only across all threads and ranks, and outlives individual solver invocations. The `Send + Sync` property follows from the indexer containing only `usize` and `Range<usize>` fields — no heap-allocated mutable state.
- **Patch symmetry for state transfer**: The design explicitly makes lag fixing row $N + \ell \cdot N + h$ match lag column $N + \ell \cdot N + h$. This means state transfer patches can be written as: for each index $i \in [0, n_{state})$, `patch(row = cut_row(i), value = state[i])`. The symmetry simplifies implementation and eliminates a separate index table.
- **lp-formulation.md gets a reverse cross-reference**: The math spec now explicitly links back to Solver Abstraction SS2 as the implementation of its constraint families. This was out of scope in the original ticket but correct — the math spec without the implementation link left a navigation gap. Quality was docked for scope deviation, but the content is correct.

## Patterns Established

- **Worked example as a verification baseline**: The 3-hydro AR(2) system in Solver Abstraction SS2.4 is explicitly framed as "a verification baseline for implementers." This pattern should be used for any spec that introduces index arithmetic — a concrete small example that a developer can trace by hand. File: `src/specs/architecture/solver-abstraction.md` SS2.4.
- **Patch sequence subsection (SS4.2a)**: The forward pass now has a dedicated subsection for the exact `patch_rhs_bounds` calls. This pattern of a "step N.a" subsection breaking down a complex algorithm step into concrete operations can be applied to other multi-step spec sections. File: `src/specs/architecture/training-loop.md` SS4.2a.
- **StageIndexer as the index authority**: All LP position lookups flow through `StageIndexer`. The spec explicitly says "eliminates magic index numbers from the training loop." Future specs that reference LP positions should link to the indexer rather than re-deriving formulas. File: `src/specs/architecture/training-loop.md` SS5.5.
- **Performance justification as spec content**: Section SS2.5 (Performance Notes) in `solver-abstraction.md` documents SIMD alignment, cache occupancy, and contiguous access patterns with numeric analysis. This is not implementation guidance — it is the performance rationale for the design, and it belongs in the spec. Future performance-critical sections should follow this pattern.

## Recommendations for Epic 04

- Epic 04 addresses High-severity gaps (tickets 011-016). The LP layout and StageIndexer defined in epic-03 are prerequisites for several of these: ticket-011 (state vector wire format) needs the $n_{state}$ formula; ticket-013 (AR lag fixing constraints) must match the row layout from SS2.2; ticket-014 (patch_rhs_bounds split) depends on the patch sequence from SS4.2a.
- The `ar_dynamics_row(h)` placeholder in SS4.2a (the noise fixing row offset) may be addressed by ticket-013 (AR lag fixing constraints) or ticket-014 (patch_rhs_bounds split). Whoever refines those tickets should check whether they can close this open point.
- The scope boundary issue from ticket-010 suggests that future bookkeeping tickets (gap inventory + cross-references) should include an explicit "files to audit for cross-references" section, derived by grepping for references to the changed specs before writing the ticket. This would have caught `lp-formulation.md` at planning time.
- `sddp-specialist` remains the correct agent for all epic-04 tickets that involve LP constraint details, state vector formats, or cut computation. The specialist's track record is 3/3 first-attempt guardian passes in epic-03.
